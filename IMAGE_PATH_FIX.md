# åœ–åƒè·¯å¾‘å•é¡Œä¿®æ­£èªªæ˜

## ğŸ” ç™¼ç¾çš„å•é¡Œ

### 1. è·¯å¾‘å®‰å…¨æ€§å•é¡Œ
- **å•é¡Œ**ï¼š`/api/storage/[...path]/route.ts` æ²’æœ‰æª¢æŸ¥è·¯å¾‘å®‰å…¨æ€§
- **é¢¨éšª**ï¼šå¯èƒ½è¢«è·¯å¾‘éæ­·æ”»æ“Šï¼ˆ`../../../etc/passwd`ï¼‰
- **å½±éŸ¿**ï¼šå®‰å…¨æ€§æ¼æ´ï¼Œå¯èƒ½å°è‡´æª”æ¡ˆç³»çµ±è¢«å­˜å–

### 2. éŒ¯èª¤è™•ç†ä¸è¶³
- **å•é¡Œ**ï¼šæª”æ¡ˆè®€å–å¤±æ•—æ™‚æ²’æœ‰è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
- **å½±éŸ¿**ï¼šé™¤éŒ¯å›°é›£ï¼Œç„¡æ³•çŸ¥é“å…·é«”å¤±æ•—åŸå› 

### 3. ç›®éŒ„å‰µå»ºå¤±æ•—è™•ç†
- **å•é¡Œ**ï¼š`storage/outputs` ç›®éŒ„å‰µå»ºå¤±æ•—æ™‚æ²’æœ‰æ˜ç¢ºéŒ¯èª¤
- **å½±éŸ¿**ï¼šåœ¨ Zeabur ç’°å¢ƒå¯èƒ½å› ç‚ºæ¬Šé™å•é¡Œå°è‡´å¤±æ•—

### 4. æª”æ¡ˆå¯«å…¥å¤±æ•—è™•ç†
- **å•é¡Œ**ï¼šæª”æ¡ˆå¯«å…¥å¤±æ•—æ™‚æ²’æœ‰è©³ç´°éŒ¯èª¤è¨Šæ¯
- **å½±éŸ¿**ï¼šç„¡æ³•çŸ¥é“ç‚ºä»€éº¼åœ–ç‰‡ç„¡æ³•å„²å­˜

## âœ… ä¿®æ­£å…§å®¹

### 1. è·¯å¾‘å®‰å…¨æ€§æª¢æŸ¥
```typescript
// ç§»é™¤è·¯å¾‘ä¸­çš„ .. é˜²æ­¢è·¯å¾‘éæ­·
const safePath = params.path.map(p => p.replace(/\.\./g, '')).join('/');

// ç¢ºä¿æª”æ¡ˆè·¯å¾‘åœ¨ storage ç›®éŒ„å…§
if (!filePath.startsWith(storageDir)) {
  return NextResponse.json({ error: 'Invalid path' }, { status: 400 });
}
```

### 2. æ”¹å–„éŒ¯èª¤è™•ç†
- åŠ å…¥è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
- è¨˜éŒ„éŒ¯èª¤åˆ° console æ–¹ä¾¿é™¤éŒ¯
- è¿”å›æ›´æ˜ç¢ºçš„éŒ¯èª¤ç‹€æ…‹ç¢¼

### 3. ç›®éŒ„å‰µå»ºéŒ¯èª¤è™•ç†
```typescript
try {
  await mkdir(outputDir, { recursive: true });
} catch (error) {
  console.error('Failed to create output directory:', error);
  throw new Error(`ç„¡æ³•å»ºç«‹è¼¸å‡ºç›®éŒ„: ${error.message}`);
}
```

### 4. æª”æ¡ˆå¯«å…¥éŒ¯èª¤è™•ç†
```typescript
try {
  await writeFile(filepath, finalImage);
  console.log(`Image saved: ${filepath}`);
} catch (writeError) {
  console.error(`Failed to write file ${filepath}:`, writeError);
  throw new Error(`ç„¡æ³•å„²å­˜æª”æ¡ˆ: ${writeError.message}`);
}
```

## ğŸ“‹ è·¯å¾‘æµç¨‹

1. **ç”Ÿæˆåœ–ç‰‡** â†’ å„²å­˜åˆ° `storage/outputs/{jobId}_{index}.png`
2. **è¿”å›è·¯å¾‘** â†’ `/api/storage/outputs/{jobId}_{index}.png`
3. **å‰ç«¯è«‹æ±‚** â†’ `GET /api/storage/outputs/{filename}`
4. **API è™•ç†** â†’ è®€å–æª”æ¡ˆä¸¦è¿”å›åœ–ç‰‡

## ğŸ” å®‰å…¨æ€§æ”¹é€²

- âœ… è·¯å¾‘éæ­·æ”»æ“Šé˜²è­·
- âœ… è·¯å¾‘é©—è­‰ï¼ˆç¢ºä¿åœ¨ storage ç›®éŒ„å…§ï¼‰
- âœ… è©³ç´°éŒ¯èª¤æ—¥èªŒï¼ˆæ–¹ä¾¿é™¤éŒ¯ï¼‰

## ğŸš€ éƒ¨ç½²å¾Œæª¢æŸ¥

å¦‚æœåœ–ç‰‡é‚„æ˜¯ç„¡æ³•é¡¯ç¤ºï¼Œæª¢æŸ¥ï¼š

1. **Zeabur æ—¥èªŒ**ï¼šæŸ¥çœ‹æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
2. **ç›®éŒ„æ¬Šé™**ï¼šç¢ºèª `storage` ç›®éŒ„å¯ä»¥å¯«å…¥
3. **æª”æ¡ˆæ˜¯å¦å­˜åœ¨**ï¼šæª¢æŸ¥æª”æ¡ˆæ˜¯å¦æˆåŠŸå‰µå»º
4. **API è·¯ç”±**ï¼šç¢ºèª `/api/storage/[...path]` è·¯ç”±æ­£å¸¸é‹ä½œ
